# .github/workflows/deploy-simple.yml
name: Simple Oracle Cloud Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup OCI CLI
        uses: oracle-actions/configure-oci-cli@v1.3.0
        with:
          user: ${{ secrets.OCI_USER_ID }}
          fingerprint: ${{ secrets.OCI_FINGERPRINT }}
          tenancy: ${{ secrets.OCI_TENANCY_ID }}
          region: ${{ secrets.OCI_REGION }}
          private_key: ${{ secrets.OCI_PRIVATE_KEY }}
      
      - name: Build and Deploy
        run: |
          # Build Docker image
          docker build -t dinari-blockchain .
          
          # Tag for Oracle Registry
          docker tag dinari-blockchain ${{ secrets.OCI_REGISTRY }}/dinari-blockchain:latest
          
          # Login and push
          echo "${{ secrets.OCI_TOKEN }}" | docker login ${{ secrets.OCI_REGISTRY }} -u ${{ secrets.OCI_USERNAME }} --password-stdin
          docker push ${{ secrets.OCI_REGISTRY }}/dinari-blockchain:latest
      
      - name: Deploy to Container Instance
        run: |
          # Create container instance
          oci container-instances container-instance create \
            --compartment-id ${{ secrets.OCI_TENANCY_ID }} \
            --availability-domain $(oci iam availability-domain list --compartment-id ${{ secrets.OCI_TENANCY_ID }} --query 'data[0].name' --raw-output) \
            --shape "CI.Standard.E4.Flex" \
            --shape-config '{"ocpus": 1, "memory_in_gbs": 4}' \
            --display-name "dinari-blockchain-$(date +%s)" \
            --containers '[{
              "displayName": "dinari-blockchain",
              "imageUrl": "${{ secrets.OCI_REGISTRY }}/dinari-blockchain:latest",
              "resourceConfig": {
                "memoryLimitInGBs": 4,
                "vcpusLimit": 1
              },
              "environmentVariables": {
                "LEVELDB_PATH": "/app/blockchain_data",
                "FLASK_ENV": "production",
                "BLOCKCHAIN_NETWORK": "mainnet",
                "P2P_PORT": "8333",
                "API_PORT": "5000",
                "ENABLE_MINING": "true"
              }
            }]' \
            --vnics '[{
              "subnetId": "'$(oci network subnet list --compartment-id ${{ secrets.OCI_TENANCY_ID }} --query 'data[0].id' --raw-output)'",
              "assignPublicIp": true
            }]'
      
      - name: Get Instance IP
        run: |
          echo "ðŸš€ DinariBlockchain deployed!"
          echo "Check your Oracle Cloud Console for the instance IP address"
          echo "Your blockchain will be available at: http://INSTANCE_IP:5000"