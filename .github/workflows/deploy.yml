# .github/workflows/deploy-simple.yml
name: Simple Oracle Cloud Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup OCI CLI
        run: |
          # Install OCI CLI non-interactively
          bash -c "$(curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh)" -- --accept-all-defaults
          echo "$HOME/bin" >> $GITHUB_PATH
      
      - name: Configure OCI CLI
        run: |
          # Create OCI config directory
          mkdir -p ~/.oci
          
          # Create OCI config file
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=${{ secrets.OCI_USER_ID }}
          fingerprint=${{ secrets.OCI_FINGERPRINT }}
          tenancy=${{ secrets.OCI_TENANCY_ID }}
          region=${{ secrets.OCI_REGION }}
          key_file=~/.oci/oci_api_key.pem
          EOF
          
          # Create private key file
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          
          # Test OCI CLI
          oci iam region list --output table
      
      - name: Build and Push Docker Image
        run: |
          # Build Docker image
          docker build -t dinari-blockchain .
          
          # Tag for Oracle Registry
          docker tag dinari-blockchain ${{ secrets.OCI_REGISTRY }}/dinari-blockchain:latest
          
          # Login to Oracle Container Registry
          echo "${{ secrets.OCI_TOKEN }}" | docker login ${{ secrets.OCI_REGISTRY }} -u ${{ secrets.OCI_USERNAME }} --password-stdin
          
          # Push to registry
          docker push ${{ secrets.OCI_REGISTRY }}/dinari-blockchain:latest
          
          echo "âœ… Docker image pushed successfully!"
      
      - name: Deploy to Oracle Container Instance
        run: |
          # Get first availability domain
          AD=$(oci iam availability-domain list --compartment-id ${{ secrets.OCI_TENANCY_ID }} --query 'data[0].name' --raw-output)
          echo "Using Availability Domain: $AD"
          
          # Create container instance
          oci container-instances container-instance create \
            --compartment-id ${{ secrets.OCI_TENANCY_ID }} \
            --availability-domain "$AD" \
            --shape "CI.Standard.E4.Flex" \
            --shape-config '{"ocpus": 1, "memory_in_gbs": 4}' \
            --display-name "dinari-blockchain-$(date +%s)" \
            --containers '[{
              "displayName": "dinari-blockchain",
              "imageUrl": "${{ secrets.OCI_REGISTRY }}/dinari-blockchain:latest",
              "resourceConfig": {
                "memoryLimitInGBs": 4,
                "vcpusLimit": 1
              },
              "environmentVariables": {
                "LEVELDB_PATH": "/app/blockchain_data",
                "FLASK_ENV": "production",
                "BLOCKCHAIN_NETWORK": "mainnet",
                "P2P_PORT": "8333",
                "API_PORT": "5000",
                "ENABLE_MINING": "true"
              }
            }]' \
            --wait-for-state RUNNING \
            --max-wait-seconds 300
          
          echo "ðŸš€ DinariBlockchain deployed successfully!"
          echo "Check Oracle Cloud Console â†’ Container Instances for your running blockchain"